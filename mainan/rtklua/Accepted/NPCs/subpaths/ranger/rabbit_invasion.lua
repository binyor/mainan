rabbit_invasion_set = {
	{
		{1, 15, 7},
		{1, 16, 7},
		{1, 17, 7},
		{1, 18, 7},
		{1, 19, 7},
		{1, 17, 8},
		{1, 16, 8},
		{1, 18, 8},
		{1, 17, 9}
	},
	{
		{1, 15, 7},
		{1, 16, 7},
		{1, 17, 7},
		{1, 18, 7},
		{1, 19, 7},
		{2, 17, 8},
		{2, 16, 8},
		{2, 18, 8},
		{1, 17, 9}
	},
	{
		{2, 15, 7},
		{1, 16, 7},
		{2, 17, 7},
		{1, 18, 7},
		{2, 19, 7},
		{2, 17, 8},
		{2, 16, 8},
		{2, 18, 8},
		{3, 17, 9}
	},
	{
		{1, 11, 7},
		{1, 12, 8},
		{1, 13, 9},
		{1, 14, 8},
		{1, 15, 7},
		{1, 16, 8},
		{1, 17, 9},
		{1, 18, 8},
		{1, 19, 7},
		{1, 20, 8},
		{1, 21, 9},
		{1, 22, 8},
		{1, 23, 7}
	},
	{
		{1, 11, 7},
		{2, 12, 8},
		{1, 13, 9},
		{2, 14, 8},
		{1, 15, 7},
		{2, 16, 8},
		{1, 17, 9},
		{2, 18, 8},
		{1, 19, 7},
		{2, 20, 8},
		{1, 21, 9},
		{2, 22, 8},
		{1, 23, 7}
	},
	{
		{2, 11, 7},
		{3, 12, 8},
		{2, 13, 9},
		{3, 14, 8},
		{2, 15, 7},
		{3, 16, 8},
		{2, 17, 9},
		{3, 18, 8},
		{2, 19, 7},
		{3, 20, 8},
		{2, 21, 9},
		{3, 22, 8},
		{2, 23, 7}
	},
	{
		{3, 11, 7},
		{3, 12, 8},
		{3, 13, 9},
		{3, 14, 8},
		{3, 15, 7},
		{3, 16, 8},
		{3, 17, 9},
		{3, 18, 8},
		{3, 19, 7},
		{3, 20, 8},
		{3, 21, 9},
		{3, 22, 8},
		{3, 23, 7}
	},
	{
		{1, 11, 7},
		{2, 11, 9},
		{3, 12, 8},
		{4, 13, 7},
		{5, 13, 9},
		{1, 14, 8},
		{2, 15, 7},
		{3, 15, 9},
		{4, 16, 8},
		{5, 17, 9},
		{1, 17, 7},
		{2, 18, 8},
		{3, 19, 9},
		{4, 19, 7},
		{5, 19, 7},
		{1, 20, 8},
		{2, 21, 9},
		{3, 21, 7},
		{4, 22, 8},
		{5, 23, 9},
		{1, 23, 7}
	},
	{
		{3, 11, 7},
		{4, 11, 9},
		{3, 12, 8},
		{4, 13, 7},
		{3, 13, 9},
		{4, 14, 8},
		{3, 15, 7},
		{4, 15, 9},
		{3, 16, 8},
		{4, 17, 9},
		{3, 17, 7},
		{4, 18, 8},
		{3, 19, 9},
		{4, 19, 7},
		{3, 19, 7},
		{4, 20, 8},
		{3, 21, 9},
		{4, 21, 7},
		{3, 22, 8},
		{4, 23, 9},
		{3, 23, 7}
	},
	{
		{4, 11, 7},
		{4, 11, 9},
		{4, 12, 8},
		{4, 13, 7},
		{4, 13, 9},
		{4, 14, 8},
		{4, 15, 7},
		{4, 15, 9},
		{4, 16, 8},
		{4, 17, 9},
		{4, 17, 7},
		{4, 18, 8},
		{4, 19, 9},
		{4, 19, 7},
		{4, 19, 7},
		{4, 20, 8},
		{4, 21, 9},
		{4, 21, 7},
		{4, 22, 8},
		{4, 23, 9},
		{4, 23, 7}
	},
	{
		{5, 11, 7},
		{5, 11, 9},
		{5, 12, 8},
		{5, 13, 7},
		{5, 13, 9},
		{5, 14, 8},
		{5, 15, 7},
		{5, 15, 9},
		{5, 16, 8},
		{5, 17, 9},
		{5, 17, 7},
		{5, 18, 8},
		{5, 19, 9},
		{5, 19, 7},
		{5, 19, 7},
		{5, 20, 8},
		{5, 21, 9},
		{5, 21, 7},
		{5, 22, 8},
		{5, 23, 9},
		{5, 23, 7}
	},
	{{6, 17, 15}},
	{
		{5, 15, 7},
		{5, 16, 7},
		{6, 17, 7},
		{5, 18, 7},
		{5, 19, 7},
		{5, 17, 8},
		{5, 16, 8},
		{5, 18, 8},
		{5, 17, 9},
		{5, 17, 10},
		{5, 17, 11},
		{5, 17, 12},
		{5, 17, 13},
		{5, 17, 14},
		{5, 17, 13}
	},
	{
		{6, 11, 7},
		{6, 11, 9},
		{6, 12, 8},
		{6, 13, 7},
		{6, 13, 9},
		{6, 14, 8},
		{6, 15, 7},
		{6, 15, 9},
		{6, 16, 8},
		{6, 17, 9},
		{6, 17, 7},
		{6, 18, 8},
		{6, 19, 9},
		{6, 19, 7},
		{6, 19, 7},
		{6, 20, 8},
		{6, 21, 9},
		{6, 21, 7},
		{6, 22, 8},
		{6, 23, 9},
		{6, 23, 7}
	}
}

RabbitInvasionNpc = {
	action = function(npc)
		if #rabbit_invasion_queue > 0 and os.time() > npc.mapRegistry[
			"rabbit_invasion_finish"
		] + 15 then
			local player = Player(rabbit_invasion_queue[1])

			if player == nil then
				table.remove(rabbit_invasion_queue, 1)
				return
			end

			if player.m ~= 44175 then
				table.remove(rabbit_invasion_queue, 1)
				return
			end

			if player.registry["rabbit_invasion"] == 0 then
				player:warp(44175, 17, 21)
				player.mapRegistry["rabbit_invasion_player"] = player.ID
				player.registry["rabbit_invasion"] = 1
				player.registry["rabbit_invasion_round"] = 1
				player.registry["rabbit_invasion_time"] = os.time()
				player.registry["rabbit_invasion_score"] = 0
				player.registry["rabbit_invasion_damage"] = 0

				clone.wipe(player)
				clone.equip(player, player)
				player.gfxWeap = 20000
				player.gfxClone = 1
				player:updateState()
			end

			if player.registry["rabbit_invasion"] == 1 and player.m == 44175 then
				if RabbitInvasionNpc.noRabbits(player) and os.time() > player.registry[
					"rabbit_invasion_time"
				] + 5 and os.time() > player.mapRegistry[
					"rabbit_invasion_last_kill"
				] + 5 then
					RabbitInvasionNpc.spawnRabbits(
						player,
						player.registry["rabbit_invasion_round"]
					)
				else
					RabbitInvasionNpc.checkPlayers(npc)
					RabbitInvasionNpc.moveRabbits(player)
					RabbitInvasionNpc.checkEnd(player)
				end
			end
		end
	end,
	click = async(function(player, npc)
		local t = {
			graphic = convertGraphic(npc.look, "monster"),
			color = npc.lookColor
		}
		player.npcGraphic = t.graphic
		player.npcColor = t.color
		player.dialogType = 0
		player.lastClick = npc.ID

		local opts = {"Join Queue", "Leave Queue"}

		local menu = player:menuString(
			"Can you help me stop the rabbits attacking my crops?",
			opts
		)

		if menu == "Join Queue" then
			player.registry["rabbit_invasion"] = 0
			RabbitInvasionNpc.addToQueue(player.name)
		elseif menu == "Leave Queue" then
			RabbitInvasionNpc.removeFromQueue(player.name)
		end
	end),
	checkPlayers = function(npc)
		local found = false
		for x = 10, 24 do
			local pc = npc:getObjectsInCell(npc.m, x, 21, BL_PC)
			if #pc > 0 then
				found = true
			end
		end
		if not found then
			local mobs = player:getObjectsInSameMap(BL_MOB)
			for i = 1, #mobs do
				mobs[i].attacker = 0
				mobs[i]:removeHealth(1000000)
			end
			npc.mapRegistry["rabbit_invasion_finish"] = os.time()
			table.remove(rabbit_invasion_queue, 1)
		end
	end,
	shoot = function(player)
		if player.side == 0 then
			for i = 1, 14 do
				mob = getTargetFacing(player, BL_MOB, 0, i)

				if mob ~= nil then
					mob.attacker = player.ID
					mob:removeHealth(1 + player.registry["rabbit_invasion_damage"])
					player:throw(mob.x, mob.y, 6, 0, 1)
					return
				end
			end
			player.registry["rabbit_invasion_score"] = player.registry[
				"rabbit_invasion_score"
			] - 1
			player:throw(player.x, player.y - 15, 6, 0, 1)
		end
	end,
	checkEnd = function(player)
		local mobs = player:getObjectsInSameMap(BL_MOB)
		local dead = false
		if #mobs > 0 then
			for i = 1, #mobs do
				if mobs[i].y == 20 then
					dead = true
				end
			end
			if dead then
				for i = 1, #mobs do
					mobs[i].attacker = 0
					mobs[i]:removeHealth(1000000)
				end
				player:warp(44175, 5, 5)
				player.registry["rabbit_invasion"] = 0
				player.mapRegistry["rabbit_invasion_finish"] = os.time()
				clone.wipe(player)
				player:updateState()
				if player.registry["rabbit_invasion_score"] < 0 then
					player.registry["rabbit_invasion_score"] = 0
				end
				player:sendMinitext("Final Score: " .. player.registry["rabbit_invasion_score"])
				if player.registry["rabbit_invasion_score"] > player.registry[
					"rabbit_invasion_highest_score"
				] then
					player.registry["rabbit_invasion_highest_score"] = player.registry[
						"rabbit_invasion_score"
					]
					player:removeLegendbyName("rabbitinvasionhighscore")
					player:addLegend(
						"Highest score in rabbit invasion " .. player.registry[
							"rabbit_invasion_highest_score"
						],
						"rabbitinvasionhighscore",
						212,
						1
					)
				end
				table.remove(rabbit_invasion_queue, 1)
			end
		end
	end,
	noRabbits = function(player)
		local mobs = player:getObjectsInSameMap(BL_MOB)
		if #mobs == 0 then
			return true
		else
			return false
		end
	end,
	spawnRabbits = function(player, round)
		for i = 1, #rabbit_invasion_set[round] do
			if rabbit_invasion_set[round][i][1] == 1 then
				player:spawn(
					719,
					rabbit_invasion_set[round][i][2],
					rabbit_invasion_set[round][i][3],
					1
				)
			end
			if rabbit_invasion_set[round][i][1] == 2 then
				player:spawn(
					720,
					rabbit_invasion_set[round][i][2],
					rabbit_invasion_set[round][i][3],
					1
				)
			end
			if rabbit_invasion_set[round][i][1] == 3 then
				player:spawn(
					721,
					rabbit_invasion_set[round][i][2],
					rabbit_invasion_set[round][i][3],
					1
				)
			end
			if rabbit_invasion_set[round][i][1] == 4 then
				player:spawn(
					722,
					rabbit_invasion_set[round][i][2],
					rabbit_invasion_set[round][i][3],
					1
				)
			end
			if rabbit_invasion_set[round][i][1] == 5 then
				player:spawn(
					723,
					rabbit_invasion_set[round][i][2],
					rabbit_invasion_set[round][i][3],
					1
				)
			end
			if rabbit_invasion_set[round][i][1] == 6 then
				player:spawn(
					724,
					rabbit_invasion_set[round][i][2],
					rabbit_invasion_set[round][i][3],
					1
				)
			end
		end
		player.registry["rabbit_invasion_round"] = player.registry[
			"rabbit_invasion_round"
		] + 1
		player.registry["rabbit_invasion_time"] = os.time()
		player.registry["rabbit_invasion_move_timer"] = 30
		player.registry["rabbit_invasion_counter"] = 0
		player.mapRegistry["rabbit_invasion_direction"] = 0
	end,
	moveRabbits = function(player)
		player.registry["rabbit_invasion_counter"] = player.registry[
			"rabbit_invasion_counter"
		] + 1

		if player.registry["rabbit_invasion_counter"] == player.registry[
			"rabbit_invasion_move_timer"
		] then
			player.registry["rabbit_invasion_counter"] = 0

			local rightside = false
			local leftside = false

			local mobs = player:getObjectsInSameMap(BL_MOB)

			for i = 1, #mobs do
				if mobs[i].x == 24 then
					rightside = true
				end
				if mobs[i].x == 10 then
					leftside = true
				end
			end

			if player.mapRegistry["rabbit_invasion_direction"] == 100 then
				player.mapRegistry["rabbit_invasion_direction"] = 0
				leftside = false
				rightside = false
			end

			if player.mapRegistry["rabbit_invasion_direction"] == 101 then
				player.mapRegistry["rabbit_invasion_direction"] = 1
				leftside = false
				rightside = false
			end

			for i = 1, #mobs do
				if (rightside or leftside) and mobs[i].mapRegistry["rabbit_invasion_direction"] ~= 100 and mobs[
					i
				].mapRegistry["rabbit_invasion_direction"] ~= 101 then
					mobs[i].side = 2
					mobs[i]:sendSide()
					mobs[i]:moveIgnoreObject()
				end
				if mobs[i].mapRegistry["rabbit_invasion_direction"] == 0 and not rightside then
					mobs[i].side = 1
					mobs[i]:sendSide()
					mobs[i]:moveIgnoreObject()
				end
				if mobs[i].mapRegistry["rabbit_invasion_direction"] == 1 and not leftside then
					mobs[i].side = 3
					mobs[i]:sendSide()
					mobs[i]:moveIgnoreObject()
				end
			end

			if rightside or leftside then
				if player.mapRegistry["rabbit_invasion_direction"] == 0 then
					player.mapRegistry["rabbit_invasion_direction"] = 101
				end
				if player.mapRegistry["rabbit_invasion_direction"] == 1 then
					player.mapRegistry["rabbit_invasion_direction"] = 100
				end
				rightside = false
				leftside = false
				player.registry["rabbit_invasion_move_timer"] = player.registry[
					"rabbit_invasion_move_timer"
				] - 3
				if player.registry["rabbit_invasion_move_timer"] < 5 then
					player.registry["rabbit_invasion_move_timer"] = 5
				end
			end
		end
	end,
	getNewPlayer = function(npc)
		local empty = true
		for x = 10, 24 do
			local obj = npc:getObjectInCell(npc.m, x, 21, BL_PC)
			if #obj > 0 then
				empty = false
			end
		end
		if empty == true then
			player:warp(npc.m, 17, 21)
		end
	end,
	removeFromQueue = function(name)
		local player = Player(name)
		for i = 1, #rabbit_invasion_queue do
			if rabbit_invasion_queue[i] == name then
				table.remove(rabbit_invasion_queue, i)
				player:popUp("You have been removed.")
			else
				player:popUp("You were not in the queue.")
			end
		end
	end,
	addToQueue = function(name)
		local player = Player(name)
		local found = false
		for i = 1, #rabbit_invasion_queue do
			if rabbit_invasion_queue[i] == name then
				found = true
			end
		end

		if player.state == 1 then
			player:popUp("You must be alive for this.")
			return
		end

		if found == false then
			table.insert(rabbit_invasion_queue, name)
			player:popUp("Sit tight, stay here, and don't go AFK. You have been added to the queue.")
		else
			player:popUp("You are already in the queue")
		end
	end,
	findQueuePosition = function(name)
		local player = Player(name)
		for i = 1, #rabbit_invasion_queue do
			if rabbit_invasion_queue[i] == name then
				return i
			else
				return -1
			end
		end
	end
}

rabbit_invasion_mob = {
	on_attacked = function(mob, attacker)
		mob_ai_basic.on_attacked(mob, attacker)
	end,
	after_death = function(mob, block)
		mob.mapRegistry["rabbit_invasion_last_kill"] = os.time()
		if mob.look == 21 and mob.lookColor == 3 then
			block.registry["rabbit_invasion_score"] = block.registry[
				"rabbit_invasion_score"
			] + 10
			block:sendMinitext("Score: " .. block.registry["rabbit_invasion_score"])
		end
		if mob.look == 21 and mob.lookColor == 0 then
			block.registry["rabbit_invasion_score"] = block.registry[
				"rabbit_invasion_score"
			] + 20
			block:sendMinitext("Score: " .. block.registry["rabbit_invasion_score"])
		end
		if mob.look == 21 and mob.lookColor == 12 then
			block.registry["rabbit_invasion_score"] = block.registry[
				"rabbit_invasion_score"
			] + 30
			block:sendMinitext("Score: " .. block.registry["rabbit_invasion_score"])
		end
		if mob.look == 21 and mob.lookColor == 5 then
			block.registry["rabbit_invasion_score"] = block.registry[
				"rabbit_invasion_score"
			] + 40
			block:sendMinitext("Score: " .. block.registry["rabbit_invasion_score"])
		end
		if mob.look == 21 and mob.lookColor == 7 then
			block.registry["rabbit_invasion_score"] = block.registry[
				"rabbit_invasion_score"
			] + 50
			block:sendMinitext("Score: " .. block.registry["rabbit_invasion_score"])
		end
		if mob.look == 131 and mob.lookColor == 0 then
			block.registry["rabbit_invasion_score"] = block.registry[
				"rabbit_invasion_score"
			] + 250
			block.registry["rabbit_invasion_damage"] = block.registry[
				"rabbit_invasion_damage"
			] + 1
			block:sendMinitext("Score: " .. block.registry["rabbit_invasion_score"])
		end
		if player.registry["rabbit_invasion_score"] < 0 then
			player.registry["rabbit_invasion_score"] = 0
		end
	end
}
